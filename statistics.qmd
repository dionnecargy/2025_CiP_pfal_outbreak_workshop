---
title: "Statistics"
editor: visual
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
---

```{r load-packages, include=FALSE}
library(vcfR)
library(adegenet)
library(poppr)
library(ape)
library(pegas)
library(ggplot2)
library(dplyr)
library(reshape2)
library(ggtree)
library(viridis)
library(dartR.base)
library(hierfstat)
library(tidyr)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(scales)
library(purrr)

meta <- read.table("data/metadata_samples.txt", header = TRUE, sep = "\t", stringsAsFactors = FALSE)
gl_SEA <- readRDS("derived/gl_SEA.rds")

```

## 6. Population Genetic Statistics

::: callout-note
### Exercises for Section 6. Population Genetic Statistics

-   What information do we have?
-   Generate statistics for both datasets - SEA and AFR
:::

```{r pop-stats, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Ensure order of metadata matches gl_SEA
meta_ord_SEA <- meta[match(indNames(gl_SEA), meta$sample), ]
stopifnot(all(meta_ord_SEA$sample == indNames(gl_SEA)))

# Convert to genind then extract allele matrix
gi_SEA <- gl2gi(gl_SEA)

# optional save
saveRDS(gi_SEA, file = "derived/gi_SEA.rds")

# Convert allele counts to 0/1 presence matrix
# 0 = REF, 1 = ALT
tab_SEA <- gi_SEA@tab

# malaria is haploid, but counts may be 0/1/2 in object
tab_SEA[tab_SEA > 1] <- 1      # ensure values >1 become 1
tab_SEA[is.na(tab_SEA)] <- 0   # optional but keeps dimension clean
```

```{r basic-div, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Basic diversity stats per population
pop_stats <- poppr(gi_SEA)
pop_stats

# Pairwise Fst (Nei) between populations
fst_sea <- pairwise.neifst(gi_SEA)

```

::: {.callout-note collapse="true"}
## Click to see output

```{r}
#| echo: false
fst_sea
```
:::

### **Why compute FST?**

-   Measures genetic differentiation between populations.

-   Higher FST = populations are more genetically distinct.

-   Helps identify imported clusters vs. local diversity.

### **Strengths**

-   Standard metric used in population genetics.

-   Easy to compare across studies.

### **Weaknesses**

-   Influenced by sample size.

-   Can’t distinguish drift from selection.

-   Doesn’t account for gene flow direction.

## 7. Nucleotide Diversity

```{r nucleotide-div, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
calc_pi <- function(mat) {
  p <- colMeans(mat, na.rm = TRUE)
  q <- 1 - p
  mean(2 * p * q, na.rm = TRUE)
}

pi_per_site <- meta_ord_SEA %>%
  group_split(site) %>%
  map_df(function(df_site) {
    samples <- df_site$sample
    mat <- tab_SEA[rownames(tab_SEA) %in% samples, , drop = FALSE]
    tibble(
      site = unique(df_site$site),
      pi = calc_pi(mat)
    )
  })

pi_per_site

nuc_sea <- ggplot(pi_per_site,
       aes(x = reorder(site, pi), y = pi, fill = site)) +
  geom_col() +
  theme_minimal() +
  scale_fill_viridis_d() +
  labs(
    title = "Nucleotide Diversity (π) per Site",
    x = "Site",
    y = "Nucleotide Diversity (π)"
  )
```

::: {.callout-note collapse="true"}
## Click to see plot

```{r}
#| echo: false
nuc_sea
```
:::

### **Why calculate nucleotide diversity?**

-   Measures genetic variation within a population.

-   π reflects the average number of nucleotide differences per site between two genomes.

-   In outbreak genomics:

    -   Low π → **clonal**, single-source introduction

    -   High π → **diverse**, long-standing transmission

### **Strengths**

-   Very intuitive measure of diversity

-   Useful for comparing sites, years, countries.

### **Weaknesses**

-   Requires high-quality SNP data.

-   Sensitive to missingness and uneven sample sizes.
