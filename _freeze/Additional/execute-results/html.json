{
  "hash": "a10c105e4746dd62bde2a96f69f5edb8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Additional\"\neditor: visual\noutput:\n  html_document:\n    toc: true\n    toc_float: true\n    number_sections: false\n---\n\n\n\n## 11. Connectedness Maps (grcMalaria-style)\n\n::: callout-note\n### Exercises for 11. Connectedness Maps (based on grcMalaria - <https://genremekong.org/tools/grcmalaria-guide>)\n\n-   What is this figure telling us?\n:::\n\n::: callout-warning\n## Warning\n\nYou may need to zoom into this figure to see the connections.\n:::\n\nHere we define a reusable function to map genetic connectedness between **sites or** countries\\*\\* using the PCoA distance matrix.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmap_connectedness <- function(meta, dist_mat, group_var = c(\"site\", \"country\"),\n                              measure = c(\"similarity\", \"meanDistance\"),\n                              thresholds = c(0.9, 0.8, 0.7),\n                              min_pairs = 10,\n                              xlim = c(-20, 120),\n                              ylim = c(-25, 25)) {\n\n  group_var <- match.arg(group_var)\n  measure <- match.arg(measure)\n\n  # Ensure order matches distance matrix labels\n  samples <- labels(dist_mat)\n  meta_ord <- meta[match(samples, meta$sample), ]\n  stopifnot(all(meta_ord$sample == samples))\n\n  D <- as.matrix(dist_mat)\n  max_d <- max(D)\n  S <- 1 - D / max_d  # rescaled similarity 0–1\n\n  grp <- meta_ord[[group_var]]\n\n  # Coordinates per group (centroids)\n  centers <- meta_ord %>%\n    group_by(.data[[group_var]]) %>%\n    summarise(lon = mean(longitude),\n              lat = mean(latitude),\n              .groups = \"drop\")\n\n  grp_levels <- centers[[group_var]]\n\n  edges <- list()\n\n  for (i in seq_along(grp_levels)) {\n    for (j in seq_along(grp_levels)) {\n      if (j <= i) next\n      g1 <- grp_levels[i]\n      g2 <- grp_levels[j]\n\n      idx1 <- which(grp == g1)\n      idx2 <- which(grp == g2)\n      if (length(idx1) == 0 || length(idx2) == 0) next\n\n      # all pairwise combinations between groups\n      pairs <- expand.grid(i = idx1, j = idx2)\n      if (nrow(pairs) < min_pairs) next\n\n      d_vals <- D[cbind(pairs$i, pairs$j)]\n      s_vals <- S[cbind(pairs$i, pairs$j)]\n\n      for (thr in thresholds) {\n        if (measure == \"similarity\") {\n          prop <- mean(s_vals >= thr)\n        } else { # meanDistance-style: high similarity ~ low distance\n          # interpret threshold as similarity, convert to distance cutoff\n          d_cutoff <- (1 - thr) * max_d\n          prop <- mean(d_vals <= d_cutoff)\n        }\n        if (prop > 0) {\n          edges[[length(edges) + 1]] <- data.frame(\n            g1 = g1, g2 = g2,\n            lon1 = centers$lon[centers[[group_var]] == g1],\n            lat1 = centers$lat[centers[[group_var]] == g1],\n            lon2 = centers$lon[centers[[group_var]] == g2],\n            lat2 = centers$lat[centers[[group_var]] == g2],\n            prop = prop,\n            threshold = thr,\n            stringsAsFactors = FALSE\n          )\n        }\n      }\n    }\n  }\n\n  if (length(edges) == 0) {\n    message(\"No edges above thresholds.\")\n    return(NULL)\n  }\n\n  edges_df <- do.call(rbind, edges)\n  edges_df$threshold_lab <- paste0(\"Threshold = \", edges_df$threshold)\n\n  world <- ne_countries(scale = \"medium\", returnclass = \"sf\")\n\n  p <- ggplot() +\n    geom_sf(data = world, fill = \"grey95\", color = \"grey80\") +\n    geom_segment(data = edges_df,\n                 aes(x = lon1, y = lat1,\n                     xend = lon2, yend = lat2,\n                     size = prop, color = prop),\n                 alpha = 0.8) +\n    geom_point(data = centers,\n               aes(x = lon, y = lat),\n               size = 2, color = \"black\") +\n   # geom_label(data = centers,\n  #             aes(x = lon, y = lat, label = .data[[group_var]]),\n  #             size = 3, label.size = 0.1, fill = \"white\", alpha = 0.8) +\n    coord_sf(xlim = xlim, ylim = ylim, expand = FALSE) +\n    scale_size_continuous(range = c(0.2, 2.5)) +\n    scale_color_viridis_c() +\n    facet_wrap(~ threshold_lab) +\n    theme_minimal() +\n    labs(title = paste(\"Genetic connectedness by\", group_var),\n         x = \"Longitude\", y = \"Latitude\",\n         size = \"Proportion\nhighly similar pairs\",\n         color = \"Proportion\nhighly similar pairs\")\n\n  p\n}\n```\n:::\n\n\n### 11.1. Connectedness between sites\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Use the same distance matrix from PCoA (dist_mat)\np_site <- map_connectedness(meta, dist_mat_all,\n                            group_var = \"site\",\n                            measure = \"similarity\",\n                            thresholds = c(0.9, 0.8, 0.7),\n                            min_pairs = 10)\n```\n:::\n\n\n::: {.callout-note collapse=\"true\"}\n## Click to see plot\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Additional_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n:::\n\n## 12. Discriminant Analysis of Principal Components (DAPC)\n\n::: callout-note\n### Exercises for Section 12.\n\n-   What patterns do you observe in this section?\n-   Which samples or populations stand out?\n-   What does this tell you about the outbreak or population structure?\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# NOTE: find.clusters() is interactive; this chunk is set to eval=FALSE for knitting.\n# You can run it interactively in an R session.\n\ngrp <- find.clusters(gl_all, max.n.clust = 10)  # interactive prompt for choosing K\ndapc_res <- dapc(gl_all, grp$grp)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndapc <- dapc(gl_all, n.pca=30, n.da=4)\n\nscatterplot <- scatter(dapc, scree.da=FALSE, scree.pca=FALSE,\ncell=1.5, cex=4, solid=0.8, bg=\"white\",cstar=0, clab=0, leg=TRUE)\n```\n\n::: {.cell-output-display}\n![](Additional_files/figure-html/dpac_site-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# density plots\ndensity <- scatter(dapc,1,1,  bg=\"white\",\nscree.da=FALSE, legend=TRUE, solid=0.9)\n```\n\n::: {.cell-output-display}\n![](Additional_files/figure-html/dpac_site-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# membership probability\nmembership <- compoplot(dapc, lab=\"\", posi=list(x=100,y=-.03), cleg=.7)\n```\n\n::: {.cell-output-display}\n![](Additional_files/figure-html/dpac_site-3.png){width=672}\n:::\n:::\n\n\n::: {.callout-note collapse=\"true\"}\n## Click to see plot\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nscatter.dapc(x = dapc, bg = \"white\", solid = 0.8, scree.da = FALSE, \n    scree.pca = FALSE, legend = TRUE, cstar = 0, cellipse = 1.5, \n    clabel = 0, cex = 4)\n```\n\n\n:::\n:::\n\n:::\n\n::: {.callout-note collapse=\"true\"}\n## Click to see plot\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nscatter.dapc(x = dapc, xax = 1, yax = 1, bg = \"white\", solid = 0.9, \n    scree.da = FALSE, legend = TRUE)\n```\n\n\n:::\n:::\n\n:::\n\n::: {.callout-note collapse=\"true\"}\n## Click to see plot\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n  [1]   0.7   1.9   3.1   4.3   5.5   6.7   7.9   9.1  10.3  11.5  12.7  13.9\n [13]  15.1  16.3  17.5  18.7  19.9  21.1  22.3  23.5  24.7  25.9  27.1  28.3\n [25]  29.5  30.7  31.9  33.1  34.3  35.5  36.7  37.9  39.1  40.3  41.5  42.7\n [37]  43.9  45.1  46.3  47.5  48.7  49.9  51.1  52.3  53.5  54.7  55.9  57.1\n [49]  58.3  59.5  60.7  61.9  63.1  64.3  65.5  66.7  67.9  69.1  70.3  71.5\n [61]  72.7  73.9  75.1  76.3  77.5  78.7  79.9  81.1  82.3  83.5  84.7  85.9\n [73]  87.1  88.3  89.5  90.7  91.9  93.1  94.3  95.5  96.7  97.9  99.1 100.3\n [85] 101.5 102.7 103.9 105.1 106.3 107.5 108.7 109.9 111.1 112.3 113.5 114.7\n [97] 115.9 117.1 118.3 119.5 120.7 121.9 123.1 124.3 125.5 126.7 127.9 129.1\n[109] 130.3 131.5 132.7 133.9 135.1 136.3 137.5 138.7 139.9 141.1 142.3 143.5\n[121] 144.7 145.9 147.1 148.3 149.5 150.7 151.9 153.1 154.3 155.5 156.7 157.9\n[133] 159.1 160.3 161.5 162.7 163.9 165.1 166.3 167.5 168.7 169.9 171.1 172.3\n[145] 173.5 174.7 175.9 177.1 178.3 179.5 180.7 181.9 183.1 184.3 185.5 186.7\n[157] 187.9 189.1 190.3 191.5 192.7 193.9 195.1 196.3 197.5 198.7 199.9 201.1\n[169] 202.3 203.5 204.7 205.9 207.1 208.3 209.5 210.7 211.9 213.1 214.3 215.5\n[181] 216.7 217.9 219.1 220.3 221.5 222.7 223.9 225.1 226.3 227.5 228.7 229.9\n[193] 231.1 232.3 233.5 234.7 235.9 237.1 238.3 239.5 240.7 241.9 243.1 244.3\n[205] 245.5 246.7 247.9 249.1 250.3 251.5 252.7 253.9 255.1 256.3 257.5 258.7\n[217] 259.9 261.1 262.3 263.5 264.7 265.9 267.1 268.3 269.5 270.7 271.9 273.1\n[229] 274.3 275.5 276.7 277.9 279.1 280.3 281.5 282.7 283.9 285.1 286.3 287.5\n[241] 288.7 289.9 291.1 292.3 293.5 294.7 295.9 297.1 298.3 299.5 300.7 301.9\n[253] 303.1 304.3 305.5 306.7 307.9 309.1 310.3 311.5 312.7 313.9 315.1 316.3\n[265] 317.5 318.7 319.9 321.1 322.3 323.5 324.7 325.9 327.1 328.3 329.5 330.7\n[277] 331.9 333.1 334.3 335.5 336.7 337.9 339.1 340.3 341.5 342.7 343.9 345.1\n[289] 346.3 347.5 348.7 349.9 351.1 352.3 353.5 354.7 355.9 357.1 358.3 359.5\n[301] 360.7 361.9 363.1 364.3 365.5 366.7 367.9 369.1 370.3 371.5 372.7 373.9\n[313] 375.1 376.3 377.5 378.7 379.9 381.1 382.3 383.5 384.7 385.9 387.1 388.3\n[325] 389.5 390.7 391.9 393.1 394.3 395.5 396.7 397.9 399.1 400.3 401.5 402.7\n[337] 403.9 405.1 406.3 407.5 408.7 409.9 411.1 412.3 413.5 414.7 415.9 417.1\n[349] 418.3 419.5 420.7 421.9 423.1 424.3 425.5 426.7 427.9 429.1 430.3 431.5\n[361] 432.7 433.9 435.1 436.3 437.5 438.7 439.9 441.1 442.3 443.5 444.7 445.9\n[373] 447.1 448.3 449.5 450.7 451.9 453.1 454.3 455.5 456.7 457.9 459.1 460.3\n[385] 461.5 462.7 463.9 465.1 466.3 467.5 468.7 469.9 471.1 472.3 473.5 474.7\n[397] 475.9 477.1 478.3 479.5\n```\n\n\n:::\n:::\n\n:::\n\n## **What is DAPC?**\n\n-   DAPC = Discriminant Analysis of Principal Components, implemented in *adegenet*.\n\n-   It is a multivariate clustering method specifically designed for genetic data.\n\n-   It works in two steps:\n\n    <div>\n\n    1.  PCA step → reduces dimensionality and removes linkage between loci\n    2.  Discriminant Analysis step → maximises separation among predefined groups\n\n    </div>\n\n## **Why you might choose DAPC over PCoA**\n\n### **1. DAPC explicitly maximises between-group differences**\n\n-   PCoA is *unsupervised* → it reduces the entire distance matrix in a neutral way.\n\n-   DAPC is *supervised* → you specify group labels (e.g., country, site, outbreak cluster).\n\n-   This allows DAPC to highlight **the separation you care about**, even if subtle.\n\n### **2. DAPC is more powerful for detecting population structure**\n\n-   DAPC often reveals clusters missed by PCA/PCoA.\n\n-   Particularly useful for:\n\n    -   detecting cryptic population structure\n\n    -   separating closely related subpopulations\n\n    -   identifying outbreak clusters vs. background diversity\n\n### **3. DAPC is not constrained by assumptions of Hardy–Weinberg equilibrium**\n\n-   Many traditional population genetic methods assume HWE.\n\n-   **DAPC does not**, making it suitable for:\n\n    -   mixed infections\n\n    -   clonally expanding outbreaks\n\n    -   organisms with unusual inheritance (e.g., malaria parasites)\n\n### **4. DAPC works well when the goal is *assignment or classification***\n\n-   You can classify individuals into:\n\n    -   countries\n\n    -   sites\n\n    -   haplotypes\n\n    -   outbreak vs. non-outbreak lineages\n\n-   It also provides **posterior membership probabilities**, helpful for detecting:\n\n    -   imports\n\n    -   admixture\n\n    -   migration events\n\n### **5. DAPC allows flexible selection of PCs**\n\n-   You can tune the number of PCs to:\n\n    -   avoid overfitting\n\n    -   ensure robust structure inference\n\n-   Tools like `xvalDapc()` help you identify the optimal number.\n\n## **Weaknesses of DAPC**\n\n-   **Requires predefined groups** — PCoA does not.\\\n    (Although `find.clusters()` can infer groups first.)\n\n-   **Can overfit** if too many PCs are retained.\n\n-   **Not a true evolutionary model** — separation is statistical, not phylogenetic.\n\n-   **Less intuitive** for beginners compared with PCA/PCoA.\n\n## When to use PcoA vs DAPC?\n\nPCoA shows the structure that exists naturally; DAPC shows the structure you are specifically looking for.\n\nPCoA asks: “How different are all these samples?” DAPC asks: “How different are these groups?”\n",
    "supporting": [
      "Additional_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}